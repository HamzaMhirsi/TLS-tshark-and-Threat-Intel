#!/usr/bin/python
import re
from OpenSSL.crypto import load_certificate, FILETYPE_PEM

# First of all we need to add ssl.handshake.certificate to our tshark command
# We need to split the field received as we can receive more than one certificate 

# We suppose thatw e received the field B as follow 
B="30:82:06:86:30:82:05:6e:a0:03:02:01:02:02:10:01:ef:2c:41:34:51:ab:c7:8f:cf:56:a4:97:31:f6:e2:30:0d:06:09:2a:86:48:86:f7:0d:01:01:0b:05:00:30:70:31:0b:30:09:06:03:55:04:06:13:02:55:53:31:15:30:13:06:03:55:04:0a:13:0c:44:69:67:69:43:65:72:74:20:49:6e:63:31:19:30:17:06:03:55:04:0b:13:10:77:77:77:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:31:2f:30:2d:06:03:55:04:03:13:26:44:69:67:69:43:65:72:74:20:53:48:41:32:20:48:69:67:68:20:41:73:73:75:72:61:6e:63:65:20:53:65:72:76:65:72:20:43:41:30:1e:17:0d:31:38:31:30:33:31:30:30:30:30:30:30:5a:17:0d:31:39:31:31:30:35:31:32:30:30:30:30:5a:30:81:8a:31:0b:30:09:06:03:55:04:06:13:02:55:53:31:13:30:11:06:03:55:04:08:13:0a:43:61:6c:69:66:6f:72:6e:69:61:31:16:30:14:06:03:55:04:07:13:0d:53:61:6e:20:46:72:61:6e:63:69:73:63:6f:31:16:30:14:06:03:55:04:0a:13:0d:54:77:69:74:74:65:72:2c:20:49:6e:63:2e:31:20:30:1e:06:03:55:04:0b:0c:17:74:73:61:5f:66:20:50:6f:69:6e:74:20:6f:66:20:50:72:65:73:65:6e:63:65:31:14:30:12:06:03:55:04:03:13:0b:74:77:69:74:74:65:72:2e:63:6f:6d:30:82:01:22:30:0d:06:09:2a:86:48:86:f7:0d:01:01:01:05:00:03:82:01:0f:00:30:82:01:0a:02:82:01:01:00:e7:1e:08:5d:f0:95:8d:64:c2:c9:c1:36:a3:c7:62:6e:b2:8b:3b:fa:1d:64:a7:ba:77:5e:c1:3f:18:f9:e3:2f:68:33:6c:71:8d:a2:8c:19:19:68:08:6e:55:5f:f0:f4:06:c7:6b:99:ad:32:b6:ae:57:a5:f1:62:62:67:a3:fd:7a:3c:c3:1b:70:55:74:92:d9:74:24:d9:8a:48:10:7b:5d:d4:58:49:b4:6d:24:aa:29:8d:ea:4a:60:32:c9:05:e6:ce:92:7f:80:18:7b:cc:7f:c9:8d:42:31:26:1d:22:63:c4:da:62:e0:ff:f4:76:e9:96:1e:ab:24:a0:95:82:85:1f:b6:52:43:12:a4:e5:68:33:e2:cb:f6:80:10:8c:9e:a2:1e:74:3a:d4:bb:79:a6:7d:34:c3:1c:27:a9:a9:f9:f4:dd:70:78:ee:10:36:06:48:de:72:a4:b0:c9:22:10:79:3e:12:27:f2:b3:ae:6a:12:8e:e6:fc:1c:cf:25:95:19:d1:3c:dc:bb:a5:f8:bd:6f:30:ab:37:fa:9a:da:6d:4f:cf:46:2a:e8:dd:27:79:96:cc:fe:55:bb:ed:42:9f:2e:5e:e6:08:7b:52:3f:50:c0:7c:10:44:6a:fd:5a:4d:cb:73:ae:f5:bf:b0:5a:d1:5f:a7:c8:cd:44:74:03:02:03:01:00:01:a3:82:02:ff:30:82:02:fb:30:1f:06:03:55:1d:23:04:18:30:16:80:14:51:68:ff:90:af:02:07:75:3c:cc:d9:65:64:62:a2:12:b8:59:72:3b:30:1d:06:03:55:1d:0e:04:16:04:14:d8:7a:e9:e5:af:9d:5a:1e:e9:5a:e0:20:df:fe:af:60:0f:fa:84:3a:30:27:06:03:55:1d:11:04:20:30:1e:82:0b:74:77:69:74:74:65:72:2e:63:6f:6d:82:0f:77:77:77:2e:74:77:69:74:74:65:72:2e:63:6f:6d:30:0e:06:03:55:1d:0f:01:01:ff:04:04:03:02:05:a0:30:1d:06:03:55:1d:25:04:16:30:14:06:08:2b:06:01:05:05:07:03:01:06:08:2b:06:01:05:05:07:03:02:30:75:06:03:55:1d:1f:04:6e:30:6c:30:34:a0:32:a0:30:86:2e:68:74:74:70:3a:2f:2f:63:72:6c:33:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:73:68:61:32:2d:68:61:2d:73:65:72:76:65:72:2d:67:36:2e:63:72:6c:30:34:a0:32:a0:30:86:2e:68:74:74:70:3a:2f:2f:63:72:6c:34:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:73:68:61:32:2d:68:61:2d:73:65:72:76:65:72:2d:67:36:2e:63:72:6c:30:4c:06:03:55:1d:20:04:45:30:43:30:37:06:09:60:86:48:01:86:fd:6c:01:01:30:2a:30:28:06:08:2b:06:01:05:05:07:02:01:16:1c:68:74:74:70:73:3a:2f:2f:77:77:77:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:43:50:53:30:08:06:06:67:81:0c:01:02:02:30:81:83:06:08:2b:06:01:05:05:07:01:01:04:77:30:75:30:24:06:08:2b:06:01:05:05:07:30:01:86:18:68:74:74:70:3a:2f:2f:6f:63:73:70:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:30:4d:06:08:2b:06:01:05:05:07:30:02:86:41:68:74:74:70:3a:2f:2f:63:61:63:65:72:74:73:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:44:69:67:69:43:65:72:74:53:48:41:32:48:69:67:68:41:73:73:75:72:61:6e:63:65:53:65:72:76:65:72:43:41:2e:63:72:74:30:0c:06:03:55:1d:13:01:01:ff:04:02:30:00:30:82:01:06:06:0a:2b:06:01:04:01:d6:79:02:04:02:04:81:f7:04:81:f4:00:f2:00:77:00:a4:b9:09:90:b4:18:58:14:87:bb:13:a2:cc:67:70:0a:3c:35:98:04:f9:1b:df:b8:e3:77:cd:0e:c8:0d:dc:10:00:00:01:66:cb:4d:bf:6b:00:00:04:03:00:48:30:46:02:21:00:8f:97:91:d5:57:0a:fc:dc:35:b9:cd:d3:54:ee:61:c7:45:a5:71:8e:1f:0f:da:bf:3b:a4:7d:30:6f:7e:c2:aa:02:21:00:e9:7b:2f:72:2a:31:f7:6e:51:56:0f:2b:3c:ef:01:f4:9f:9e:32:ea:10:e6:65:91:53:a3:33:ce:66:f0:8e:67:00:77:00:87:75:bf:e7:59:7c:f8:8c:43:99:5f:bd:f3:6e:ff:56:8d:47:56:36:ff:4a:b5:60:c1:b4:ea:ff:5e:a0:83:0f:00:00:01:66:cb:4d:c0:43:00:00:04:03:00:48:30:46:02:21:00:92:9c:f7:be:65:56:19:2d:3e:90:9c:18:3b:c6:47:b1:72:40:b8:36:4f:9e:df:8b:9f:88:7e:a8:f2:b6:b2:0e:02:21:00:f4:ac:25:85:19:3d:f4:b6:30:85:4a:3f:9b:0b:bb:6f:4d:4b:8a:d5:43:79:f5:f1:96:18:c7:84:95:02:f3:99:30:0d:06:09:2a:86:48:86:f7:0d:01:01:0b:05:00:03:82:01:01:00:34:2e:9d:3c:81:19:a2:73:37:20:b5:c3:55:81:79:94:d0:45:02:4e:da:d8:8c:d7:4b:4a:d8:04:f0:a4:e6:1b:1d:19:a1:c5:67:4b:95:a4:5b:b1:17:b6:e3:db:3c:19:ee:f6:e2:d3:56:c1:e8:e6:c6:86:1f:b6:59:48:34:e0:f0:ce:b0:10:48:83:91:11:34:6f:4d:e8:0a:f3:54:04:67:50:2a:77:71:97:17:8c:6f:72:51:fc:fd:09:79:d7:c1:31:d8:9f:45:d4:94:73:1d:db:16:8e:a5:73:16:cb:16:55:e2:fc:4d:83:dd:93:fc:15:e0:4a:ed:90:bd:7c:6c:62:9c:c9:7b:51:8e:28:89:d6:ee:4e:61:d8:36:74:26:14:80:c2:27:e1:20:3d:e9:92:ed:62:cb:5c:3a:03:f0:f4:77:20:49:d6:78:28:19:d4:ec:34:63:cd:eb:7f:e8:fc:11:24:9e:82:2f:c0:04:19:d6:2f:74:72:64:b5:47:8c:b5:39:81:e3:7b:d3:0c:03:6c:97:3d:25:bc:16:eb:00:23:2a:0c:de:c1:64:e8:b0:59:86:b4:62:6f:e6:51:88:c4:a7:39:67:b9:f6:cd:ed:87:8d:f0:40:ef:61:e9:2c:49:b4:fb:5e:f9:25:7f:5f:de:0d:97:64:d8:ae,30:82:04:b1:30:82:03:99:a0:03:02:01:02:02:10:04:e1:e7:a4:dc:5c:f2:f3:6d:c0:2b:42:b8:5d:15:9f:30:0d:06:09:2a:86:48:86:f7:0d:01:01:0b:05:00:30:6c:31:0b:30:09:06:03:55:04:06:13:02:55:53:31:15:30:13:06:03:55:04:0a:13:0c:44:69:67:69:43:65:72:74:20:49:6e:63:31:19:30:17:06:03:55:04:0b:13:10:77:77:77:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:31:2b:30:29:06:03:55:04:03:13:22:44:69:67:69:43:65:72:74:20:48:69:67:68:20:41:73:73:75:72:61:6e:63:65:20:45:56:20:52:6f:6f:74:20:43:41:30:1e:17:0d:31:33:31:30:32:32:31:32:30:30:30:30:5a:17:0d:32:38:31:30:32:32:31:32:30:30:30:30:5a:30:70:31:0b:30:09:06:03:55:04:06:13:02:55:53:31:15:30:13:06:03:55:04:0a:13:0c:44:69:67:69:43:65:72:74:20:49:6e:63:31:19:30:17:06:03:55:04:0b:13:10:77:77:77:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:31:2f:30:2d:06:03:55:04:03:13:26:44:69:67:69:43:65:72:74:20:53:48:41:32:20:48:69:67:68:20:41:73:73:75:72:61:6e:63:65:20:53:65:72:76:65:72:20:43:41:30:82:01:22:30:0d:06:09:2a:86:48:86:f7:0d:01:01:01:05:00:03:82:01:0f:00:30:82:01:0a:02:82:01:01:00:b6:e0:2f:c2:24:06:c8:6d:04:5f:d7:ef:0a:64:06:b2:7d:22:26:65:16:ae:42:40:9b:ce:dc:9f:9f:76:07:3e:c3:30:55:87:19:b9:4f:94:0e:5a:94:1f:55:56:b4:c2:02:2a:af:d0:98:ee:0b:40:d7:c4:d0:3b:72:c8:14:9e:ef:90:b1:11:a9:ae:d2:c8:b8:43:3a:d9:0b:0b:d5:d5:95:f5:40:af:c8:1d:ed:4d:9c:5f:57:b7:86:50:68:99:f5:8a:da:d2:c7:05:1f:a8:97:c9:dc:a4:b1:82:84:2d:c6:ad:a5:9c:c7:19:82:a6:85:0f:5e:44:58:2a:37:8f:fd:35:f1:0b:08:27:32:5a:f5:bb:8b:9e:a4:bd:51:d0:27:e2:dd:3b:42:33:a3:05:28:c4:bb:28:cc:9a:ac:2b:23:0d:78:c6:7b:e6:5e:71:b7:4a:3e:08:fb:81:b7:16:16:a1:9d:23:12:4d:e5:d7:92:08:ac:75:a4:9c:ba:cd:17:b2:1e:44:35:65:7f:53:25:39:d1:1c:0a:9a:63:1b:19:92:74:68:0a:37:c2:c2:52:48:cb:39:5a:a2:b6:e1:5d:c1:dd:a0:20:b8:21:a2:93:26:6f:14:4a:21:41:c7:ed:6d:9b:f2:48:2f:f3:03:f5:a2:68:92:53:2f:5e:e3:02:03:01:00:01:a3:82:01:49:30:82:01:45:30:12:06:03:55:1d:13:01:01:ff:04:08:30:06:01:01:ff:02:01:00:30:0e:06:03:55:1d:0f:01:01:ff:04:04:03:02:01:86:30:1d:06:03:55:1d:25:04:16:30:14:06:08:2b:06:01:05:05:07:03:01:06:08:2b:06:01:05:05:07:03:02:30:34:06:08:2b:06:01:05:05:07:01:01:04:28:30:26:30:24:06:08:2b:06:01:05:05:07:30:01:86:18:68:74:74:70:3a:2f:2f:6f:63:73:70:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:30:4b:06:03:55:1d:1f:04:44:30:42:30:40:a0:3e:a0:3c:86:3a:68:74:74:70:3a:2f:2f:63:72:6c:34:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:44:69:67:69:43:65:72:74:48:69:67:68:41:73:73:75:72:61:6e:63:65:45:56:52:6f:6f:74:43:41:2e:63:72:6c:30:3d:06:03:55:1d:20:04:36:30:34:30:32:06:04:55:1d:20:00:30:2a:30:28:06:08:2b:06:01:05:05:07:02:01:16:1c:68:74:74:70:73:3a:2f:2f:77:77:77:2e:64:69:67:69:63:65:72:74:2e:63:6f:6d:2f:43:50:53:30:1d:06:03:55:1d:0e:04:16:04:14:51:68:ff:90:af:02:07:75:3c:cc:d9:65:64:62:a2:12:b8:59:72:3b:30:1f:06:03:55:1d:23:04:18:30:16:80:14:b1:3e:c3:69:03:f8:bf:47:01:d4:98:26:1a:08:02:ef:63:64:2b:c3:30:0d:06:09:2a:86:48:86:f7:0d:01:01:0b:05:00:03:82:01:01:00:18:8a:95:89:03:e6:6d:df:5c:fc:1d:68:ea:4a:8f:83:d6:51:2f:8d:6b:44:16:9e:ac:63:f5:d2:6e:6c:84:99:8b:aa:81:71:84:5b:ed:34:4e:b0:b7:79:92:29:cc:2d:80:6a:f0:8e:20:e1:79:a4:fe:03:47:13:ea:f5:86:ca:59:71:7d:f4:04:96:6b:d3:59:58:3d:fe:d3:31:25:5c:18:38:84:a3:e6:9f:82:fd:8c:5b:98:31:4e:cd:78:9e:1a:fd:85:cb:49:aa:f2:27:8b:99:72:fc:3e:aa:d5:41:0b:da:d5:36:a1:bf:1c:6e:47:49:7f:5e:d9:48:7c:03:d9:fd:8b:49:a0:98:26:42:40:eb:d6:92:11:a4:64:0a:57:54:c4:f5:1d:d6:02:5e:6b:ac:ee:c4:80:9a:12:72:fa:56:93:d7:ff:bf:30:85:06:30:bf:0b:7f:4e:ff:57:05:9d:24:ed:85:c3:2b:fb:a6:75:a8:ac:2d:16:ef:7d:79:27:b2:eb:c2:9d:0b:07:ea:aa:85:d3:01:a3:20:28:41:59:43:28:d2:81:e3:aa:f6:ec:7b:3b:77:b6:40:62:80:05:41:45:01:ef:17:06:3e:de:c0:33:9b:67:d3:61:2e:72:87:e4:69:fc:12:00:57:40:1e:70:f5:1e:c9:b4"

# Split B in a list
HEX_list=B.split(',')

# Function that will transform the certificate from Base64 to Hex and in certificate format and calculate 
# the fingerprint
def fingerprint(HEX_list):
	fingerprints=[]
	for i in HEX_list:
		a=str(i).replace(":","")
		b = a.decode("Hex").encode("Base64")
		certificate = "-----BEGIN CERTIFICATE-----\n" + b + "-----END CERTIFICATE-----"
		cert = load_certificate(FILETYPE_PEM, certificate)
		sha1_fingerprint = cert.digest("sha1").lower().replace(":","")	
		fingerprints.append(sha1_fingerprint)
	return fingerprints

# First of all we need to set a cron that will download the blacklist.csv file each 5 min
# Here is the link https://sslbl.abuse.ch/blacklist/sslblacklist.csv

# Compare with the database
def compare(a):
	blacklist=open("sslblacklist.csv","r")
	for line in blacklist:
		sha1=line.split(',')
		try:
			for i in a:
				if i == sha1[1]:
					print "Evil Match"
				else:
					print "Safe"
		except:
			pass
	blacklist.close()

"""
a=fingerprint(HEX_list)
# add a fingeprint of a malware
a.append("65a77d36d1b53665f60d19718924504f7d3f9508")
compare(a)
"""

# We can also set the file each time we download it with this function to be more easy 
# to scan it each time and wopare values
def triage():
	blacklist=open("sslblacklist.csv","r")
	blacktriage=open("blacktriage.csv","w")
	for line in blacklist:
		sha1=line.split(',')
		try:
			blacktriage.write(sha1[1]+ "\n")
		except:
			pass
	blacklist.close()
	blacktriage.close()

"""triage()"""


